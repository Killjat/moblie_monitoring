name: Build Signed APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    # å¦‚æœä½ æœ‰ç­¾åå¯†é’¥ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä»¥ä¸‹æ­¥éª¤
    # - name: Decode Keystore
    #   env:
    #     ENCODED_STRING: ${{ secrets.KEYSTORE_BASE64 }}
    #   run: |
    #     echo $ENCODED_STRING | base64 -di > app/keystore.jks
        
    - name: Build Release APK
      run: ./gradlew assembleRelease
      # env:
      #   SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
      #   SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
      #   SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
      
    - name: Get APK Info
      id: apk_info
      run: |
        APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
        APK_NAME=$(basename "$APK_PATH")
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.apk_info.outputs.apk_path }}
        name: Release ${{ github.ref_name }}
        body: |
          ## æƒé™ç›‘æ§å™¨ ${{ github.ref_name }}
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ğŸ” æ£€æµ‹è®¿é—®é€šè®¯å½•æƒé™çš„åº”ç”¨
          - ğŸ“¸ æ£€æµ‹è®¿é—®å›¾ç‰‡/å­˜å‚¨æƒé™çš„åº”ç”¨
          - ğŸ” è¾“å…¥éªŒè¯ç "helloworld"å¯åŠ¨æ£€æµ‹
          - ğŸ“± æ˜¾ç¤ºåº”ç”¨å›¾æ ‡ã€åç§°å’Œæƒé™ä¿¡æ¯
          
          ### å®‰è£…è¯´æ˜
          1. ä¸‹è½½ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. å®‰è£… APK
          4. æ‰“å¼€åº”ç”¨å¹¶è¾“å…¥ "helloworld" å¼€å§‹ä½¿ç”¨
          
          ### ç³»ç»Ÿè¦æ±‚
          - Android 7.0 (API 24) æˆ–æ›´é«˜ç‰ˆæœ¬
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}